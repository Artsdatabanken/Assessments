@model NatureTypesListViewModel

@functions {
    void InputTag(string id, string className, string name, string[] elements, string value)
    {
        if (id == "remember_scroll")
        {
            foreach (var item in elements)
                if (item.Contains("scroll_"))
                    value = item.Replace("scroll_", string.Empty);
        }

        id = id.Replace(" ", "_");
        <input id="@id" type="checkbox" class="@className" name="@name" value="@value" @(elements.Contains(value) ? " checked=checked" : string.Empty)>
    }

    void MakeCheckBoxLi(string value, string label, string name, string[] model, string labelClassName, string inputClassName)
    {
        var id = value.Replace(" ", "_");
        <li class="checkbox">
            <label for="@id" class="@labelClassName">
                @{
                    InputTag(value, $"{inputClassName} submitOnclick", name, model, value);
                }
                <span class="label_text">@label</span>
            </label>
        </li>
    }

    void MakeFilterElement(string buttonText, string filterName, string buttonname)
    {
        var action = $"show_{filterName.ToLower()}";
        var id = $"list_header_{filterName.ToLower()}";

        InputTag(action, "collapse_checkbox", "IsCheck", Model.IsCheck, filterName);
        <button name="@buttonname" class="list_header" id="@id" onclick="collapse('@action')" type="button">
            @buttonText
            <span class="filternumber">
                @Context.Request.Query[filterName].Count
            </span>
        </button>
    }

    void MakeFilterGroup(string filterName, string modelName, bool isSubGroup, string[] filterModel, FilterHelpers.FilterAndMetaData filterItems, string buttonText, string buttonName, string outerClassName)
    {
        var className = isSubGroup ? $"filter_subgroup filter_{filterName.ToLower()}" : $"filter_{filterName.ToLower()}";

        <li class="filter_group">
            @{
                MakeFilterElement(buttonText, filterName, buttonName);
            }
            <div class="@className">
                @{
                    if (!string.IsNullOrEmpty(filterItems.FilterDescription))
                    {
                        <div class="filter_info_text">@filterItems.FilterDescription</div>
                    }
                }
                <ul>
                    @{
                        const string markAllClassName = "mark_all";

                        if (filterItems.Filters.Length > 4)
                            MakeCheckBoxLi(filterName, "Merk alle", modelName, filterModel, markAllClassName, outerClassName);

                        foreach (var el in filterItems.Filters)
                        {
                            var value = el.NameShort;
                            var label = filterName == nameof(Model.Category) && value != "RED" && value != "END" ? $"{el.NameShort} - {el.Description}" : el.Name;
                            var extraOuterClassName = $"{outerClassName} {filterName}_input";

                            if (el.SubGroup != null)
                            {
                                MakeFilterGroup(el.NameShort, modelName, true, filterModel, el.SubGroup, el.Name, $"{el.Name}filtre", extraOuterClassName);
                            }
                            else
                            {
                                MakeCheckBoxLi(value, label, modelName, filterModel, string.Empty, extraOuterClassName);
                            }
                        }
                    }
                </ul>
            </div>
        </li>
    }

    void MakeFilterGroup(string filterName, string[] filterModel, FilterHelpers.FilterAndMetaData filterItems)
    {
        MakeFilterGroup(filterName, filterName, false, filterModel, filterItems, filterItems.FilterButtonText, filterItems.FilterButtonName, string.Empty);
    }

    void RenderChip(string buttontext, string filterValue)
    {
        <li class="chips">
            <span class="chips-text">@buttontext</span>
            <button class="text-button chips-close-button btn icon-button" onclick="submitClickedElement('@filterValue')" type="submit">
                <span class="material-icons ">close</span>
            </button>
        </li>
    }

    void MakeFilterChips(string[] filterModel, FilterHelpers.FilterItem[] filterItems)
    {
        foreach (var filter in filterModel)
        {
            var buttonText = RedlistSpeciesFilterHelpers.GetChipText(filter, filterItems);
            if (!string.IsNullOrEmpty(buttonText))
                RenderChip(buttonText, filter);
        }
    }
}

<div class="empty_filters">
    <p class="hit_count_text">
        <div class="searchstring">
            <span is-visible="!string.IsNullOrEmpty(Model.Name)">
                <span>
                    @($"Viser treff for \"{Model.Name.Trim()}\"")
                </span>
                <a href="@Context.Request.QueryString.RemoveParameters([nameof(NatureTypesListViewModel.Name), nameof(Model.Name), "Page"])" class="button tinybutton tertiary search_related">
                    <span class="material-icons">close</span>Fjern søk
                </a>
            </span>
            <div class="filterbox">
                <ul>
                    @if (NatureTypesFilterHelpers.GetActiveSelectionCount(Model) > 0)
                    {
                        MakeFilterChips(Model.Area, NatureTypesFilterHelpers.Areas.Filters);
                        MakeFilterChips(Model.Category, NatureTypesFilterHelpers.Categories.Filters);
                        MakeFilterChips(Model.Topic, NatureTypesFilterHelpers.Topics(Model.NinCodeTopics).Filters);
                        MakeFilterChips(Model.Region, NatureTypesFilterHelpers.Regions(Model.Regions).Filters);
                        MakeFilterChips(Model.CodeItem, NatureTypesFilterHelpers.CodeItems(Model.CodeItems).Filters);
                    }
                </ul>
                <a is-visible="NatureTypesFilterHelpers.GetActiveSelectionCount(Model) > 1" href="@Context.Request.QueryString.RemoveParametersExcept([nameof(Model.Name), nameof(Model.View)])" class="button tinybutton tertiary search_related">
                    <span class="material-icons">close</span>Fjern alle filter
                </a>
            </div>
        </div>
    </p>
</div>

<div class="controls">
    <span class="desktop_hide hit-counter">Viser treff @Model.Assessments.FirstItemOnPage - @Model.Assessments.LastItemOnPage av @Model.Assessments.TotalItemCount</span>
    <span class="desktop_hide">Sorter etter: </span>
    <div class="list_control_buttons">
        <button class="adb-button toggle_filter only_mobile list_actions no_js ghost" id="open_filter" value="open_filters" name="Åpne filter" type="button" onclick="openFilters()">
            @if (NatureTypesFilterHelpers.GetActiveSelectionCount(Model) != 0)
            {
                <span class="filternumber">@NatureTypesFilterHelpers.GetActiveSelectionCount(Model)</span>
            }
            <span class="material-icons">filter_list</span>Filter
        </button>

        @if (Model.ListViewViewModel.View != "stat")
        {
            <span class="mobile_hide hit-counter">Viser @Model.Assessments.FirstItemOnPage til @Model.Assessments.LastItemOnPage av totalt @Model.Assessments.TotalItemCount treff.</span>
            <span class="mobile_hide">Sorter etter: </span>
            <select asp-for="SortBy" asp-items="Html.GetEnumSelectList<SortByEnum>()" id="sort_results" class="sort_by list_actions" onchange="this.form.submit()"></select>
        }
    </div>
    <partial name="/Views/Shared/_ControlButtons.cshtml" model="new ControlButtonsViewModel { View = Model.ListViewViewModel.View }" />
    <input asp-for="View" value="stat" type="hidden" is-visible="@(Model.ListViewViewModel.View == "stat")" />
</div>

<div class="listwrapper">
    <div class="filtercontainer">
        @{
            InputTag("initial_check", "meta_checkbox", "Meta", Model.Meta, "Visited");
        }
        @{
            InputTag("remember_scroll", "meta_checkbox", "Meta", Model.Meta, "0");
        }
        <div id="filters" data-type="naturetypes" class="filteX no_js hide_on_smallscreen">
            <div id="filter_modal_background">
                <div id="filters_scrollable" class="filter_background">
                    <div class="filter_groups">
                        <partial name="/Views/Shared/_FilterHeader.cshtml" />
                        <div class="filter_scroll_area">
                            <ul>
                                @{
                                    MakeFilterGroup(nameof(Model.Area), Model.Area, NatureTypesFilterHelpers.Areas);
                                    MakeFilterGroup(nameof(Model.Category), Model.Category, NatureTypesFilterHelpers.Categories);
                                    MakeFilterGroup(nameof(Model.Topic), Model.Topic, NatureTypesFilterHelpers.Topics(Model.NinCodeTopics));
                                    MakeFilterGroup(nameof(Model.Region), Model.Region, NatureTypesFilterHelpers.Regions(Model.Regions));
                                    MakeFilterGroup(nameof(Model.CodeItem), Model.CodeItem, NatureTypesFilterHelpers.CodeItems(Model.CodeItems));
                                }
                            </ul>
                        </div>
                        <div class="filters_bottom">
                            <button class="close_filters" name="Lukk filtre" type="button" onclick="closeFilters()">
                                Avslutt
                                <span class="material-icons">close</span>
                            </button>
                            <button is-visible="false" class="hideonmobile adb-button ghost" type="submit" name="Export" value="true" formtarget="_blank">
                                <span class="material-icons">file_download</span> Eksporter
                            </button>
                            <button id="submit_filters" name="Påfør filter" type="submit" class="submit_filters primary">
                                <span class="material-icons">done</span> Påfør
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <partial name="_View.cshtml" />
</div>