@using Assessments.Shared.Interfaces
@inject IDrupalRepository DrupalRepository

@model PageMenuViewModel

@{
    var menuItems = await GetMenuItems(Model.PageMenuContentId);
    var subMenuItems = await GetMenuItems(Model.PageMenuSubContentId);
}

@functions {

    private async Task<List<KeyValuePair<string, string>>> GetMenuItems(int menuId)
    {
        var menuItems = new List<KeyValuePair<string, string>>();

        if (menuId <= 0)
            return menuItems;

        var content = await DrupalRepository.ContentById(menuId);

        if (content != null)
        {
            menuItems = content.References
                .Where(x => x.Published != null && !string.IsNullOrEmpty(x.Heading))
                .Select(x => new KeyValuePair<string, string>(x.Heading, $"https://artsdatabanken.no{x.Url}")).ToList();
        }

        return menuItems;
    }
}

<div class="sidebarmenu">
    <button class="button tertiary" onclick="expandParent(this, 'expand')">@Model.PageMenuExpandButtonText</button>
    <ul>
        <li>
            @switch (Model.AssessmentType)
            {
                case AssessmentType.AlienSpecies2023:
                    <a class="menuheaderlink" href="https://artsdatabanken.no/fremmedearter">
                        <h3>
                            <span>@Model.PageMenuExpandButtonText</span>
                            <span class="material-icons pad-top">keyboard_arrow_right</span>
                        </h3>
                    </a>
                    break;
                case AssessmentType.RedlistSpecies2021:
                    <a class="menuheaderlink" asp-controller="Species" asp-action="Index">
                        <h3>
                            <span>@Model.PageMenuExpandButtonText</span>
                            <span class="material-icons pad-top">keyboard_arrow_right</span>
                        </h3>
                    </a>
                    break;
                case AssessmentType.NatureTypes2025:
                    <a class="menuheaderlink" asp-controller="NatureTypes" asp-action="List">
                        <h3>
                            <span>@Model.PageMenuExpandButtonText</span>
                            <span class="material-icons pad-top">keyboard_arrow_right</span>
                        </h3>
                    </a>
                    break;
                default:
                    throw new ArgumentOutOfRangeException();
            }
        </li>

        @foreach (var (key, value) in menuItems)
        {
            <li>
                @if (key == "Fremmedartslista 2023")
                {
                    <a class="@(Model.ListOrAssessmentView == ListOrAssessmentView.Index ? "active-menuitem" : "")" asp-controller="AlienSpecies" asp-action="Index">
                        <span>@key </span>
                        <span is-visible="Model.ListOrAssessmentView == ListOrAssessmentView.Assessment" class="material-icons">keyboard_arrow_right</span>
                    </a>
                    @if (subMenuItems.Any())
                    {
                        <ul class="submenu-list">
                            @foreach (var (subKey, subValue) in subMenuItems)
                            {
                                <li>
                                    <a href="@subValue">
                                        <span>@subKey </span>
                                        <span class="material-icons">keyboard_arrow_right</span>
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                }
                else
                {
                    <a href="@value">
                        <span>@key </span>
                        <span class="material-icons">keyboard_arrow_right</span>
                    </a>
                }
            </li>
        }
    </ul>

    <div is-visible="Model.TableOfContentsViewModel != null" class="table-of-contents-big-screen">
        <partial name="/Views/Shared/_TableOfContents.cshtml" model="Model.TableOfContentsViewModel" />
    </div>
</div>

<script>
    function expandParent(element, className) {
        if (element.parentElement.classList.contains(className)) {
            element.parentElement.classList.remove(className);
            element.classList.remove("active");
        } else {
            element.parentElement.classList.add(className);
            element.classList.add("active");
        }
    }
</script>